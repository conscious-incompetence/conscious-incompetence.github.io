$$
%%% The font for setting inference rule names
\newcommand{\rn}[1]{\mbox{\small\sc #1}}

%%% How to display a rule's name to the right of the rule
\newcommand{\inflabel}[1]{
    \def\lab{#1}
    \ifx\lab\empty
      \relax
    \else
      (\rn{\lab})
  \fi\fi
}

%%% The ``typical'' width of the column of labels: labels are allowed
%%% to project further to the left if necessary; the rules will be
%%% centered in a column of width \linewidth - \labelcolwidth
% \newdimen\labelcolwidth

%%% Set the label column width by providing a ``typical'' label --
%%% i.e. a label of average length
%\newcommand{\typicallabel}[1]{
%  \setbox \@tempboxa \hbox{\inflabel{#1}}
%  \labelcolwidth \wd\@tempboxa
%  }
%\typicallabel{}

%%% Allocate some temporary registers
\newbox\@labelbox
\newbox\rulebox
\newdimen\ruledim
\newdimen\labeldim

%%% Put a rule and its label on the same line if this can be done
%%% without overlapping them; otherwise, put the label on the next
%%% line.  Put a small amount of vertical space above and below.
\newcommand{\layoutruleverbose}[2]%
  {\unvbox\voidb@x  % to make sure we're in vmode
   \addvspace{\bigskipamount}%

   \setbox \rulebox \hbox{$\displaystyle #2$}

   \setbox \@labelbox \hbox{#1}
   \ruledim \wd \rulebox
   \labeldim \wd \@labelbox

   %%% Will it all fit comfortably on one line?
   \@tempdima \linewidth
   \advance \@tempdima -\labelcolwidth
   \ifdim \@tempdima < \ruledim
     \@tempdima \ruledim
   \else
     \advance \@tempdima by \ruledim
     \divide \@tempdima by 2
   \fi
   \advance \@tempdima by \0.2em
   \advance \@tempdima by \labeldim
   \ifdim \@tempdima < \linewidth
     % Yes, everything fits on a line
     \@tempdima \linewidth
     \advance \@tempdima -\labelcolwidth
     \hbox to \linewidth{%
       \hbox to \@tempdima{%
         \hfil
         \box\rulebox
         \hfil}%
       \hfill
       \hbox to 0pt{\hss\box\@labelbox}%
     }%
   \else
   %
   % Will it all fit _UN_comfortably on one line?
   \@tempdima 0pt
   \advance \@tempdima by \ruledim
   \advance \@tempdima by \0.2em
   \advance \@tempdima by \labeldim
   \ifdim \@tempdima < \linewidth
     % Yes, everything fits, but not centered
     \hbox to \linewidth{%
         \hfil
         \box\rulebox
         \hskip \0.2em
         \box\@labelbox}%
   \else
   %
   % Better put the label on the next line
     \@tempdima \linewidth
     \advance \@tempdima -\labelcolwidth
     \hbox to \linewidth{%
       \hbox to \@tempdima{%
          \hfil
          \box\rulebox
          \hfil}
       \hfil}%
     \penalty10000
     \hbox to \linewidth{%
         \hfil
         \box\@labelbox}%
   \fi\fi

   \addvspace{\bigskipamount}%
   \@doendpe  % use LaTeX's trick of inhibiting paragraph indent for
              % text immediately following a rule
   \ignorespaces
   }

% Simplified form for when there is no label
\newcommand{\layoutrulenolabel}[1]%
  {\unvbox\voidb@x  % to make sure we're in vmode
   \addvspace{\bigskipamount}%

   \setbox \rulebox \hbox{$\displaystyle #1$}

   \@tempdima \linewidth
   \advance \@tempdima -\labelcolwidth
   \hbox to \@tempdima{%
      \hfil 
      \box\rulebox
      \hfil}%

   \addvspace{\bigskipamount}%
   \@doendpe  % use LaTeX's trick of inhibiting paragraph indent for
              % text immediately following a rule
   \ignorespaces
   }

% Alternate form, for when we need to save space
%\newcommand{\layoutruleterse}[2]%
%  {\noindent
%   \parbox[b]{0.5\linewidth}{\layoutruleverbose{#1}{#2}}}

\newcommand{\layoutruleterse}[2]%
  {\setbox \rulebox \hbox{$\displaystyle #2$}
   \noindent
   \parbox[b]{0.5\linewidth}
    {\vspace*{0.4em} \hfill\box\rulebox\hfill~}
   }

\newcommand{\layoutrule}[2]{\layoutruleverbose{#1}{#2}}

%%% Highlighting for new versions of rules
\newif\ifnewrule   \newrulefalse
\newcommand{\setrulebody}[1]{%
  \ifnewrule
     \@ifundefined{HIGHLIGHT}{%
        \fbox{\ensuremath{#1}}%
     }{%
        \HIGHLIGHT{#1}}%
  \else
     #1
  \fi
}

%%% Commands for setting axioms and rules
\newcommand{\typesetax}[1]{%
   \setrulebody{%
     \begin{array}{@{}c@{}}#1\end{array}}}
\newcommand{\typesetrule}[2]{%
   \setrulebody{%
      \frac{\begin{array}{@{}c@{}}#1\end{array}}%
           {\begin{array}{@{}c@{}}#2\end{array}}}}

%%% Setting axioms, with or without names
\def\infax{\@ifnextchar[{\@infaxy}{\@infaxx}}
\def\@infaxx#1{%
  \layoutrulenolabel{\typesetax{#1}}\newrulefalse\ignorespaces}
\def\@infaxy[#1]{\maybeindex{#1}\@infax{\inflabel{#1}}}
\def\@infax#1#2{\layoutrule{#1}{\typesetax{#2}}\ignorespaces}

%%% Setting rules, with or without names
\def\infrule{\@ifnextchar[{\@infruley}{\@infrulex}}
\def\@infrulex#1#2{%
  \layoutrulenolabel{\typesetrule{#1}{#2}}%
  \newrulefalse\ignorespaces}
\def\@infruley[#1]{\maybeindex{#1}\@infrule{\inflabel{#1}}}
\def\@infrule#1#2#3{\layoutrule{#1}{\typesetrule{#2}{#3}}\ignorespaces}

%%% Miscellaneous helpful definitions
\newcommand{\andalso}{\quad\quad}

% Abbreviations
\newcommand{\infabbrev}[2]{\infax{#1 \quad\eqdef\quad #2}}

$$
